<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å›¾ç‰‡è¯¦æƒ…</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/emoji-button@4.6.4/dist/emoji-button.js"></script>
</head>
<body>
<div class="container mt-4">
    <a href="/" class="btn btn-secondary mb-3">è¿”å›é¦–é¡µ</a>
    <div class="card mb-4">
        <img src="{{ url_for('static', filename='uploads/' + image[1]) }}" class="card-img-top" alt="å›¾ç‰‡">
        <div class="card-body">
            <p>ä¸Šä¼ æ—¶é—´ï¼š{{ image[4] }}</p>
            <p>ç‚¹èµæ•°ï¼š{{ image[5] }}</p>
            <button class="btn btn-sm btn-outline-info mb-2" onclick="toggleLikeUsers({{ image[0] }})">æŸ¥çœ‹ç‚¹èµç”¨æˆ·</button>
            <div id="like-users-{{ image[0] }}" class="collapse"></div>
            <a href="{{ url_for('download', filename=image[1]) }}" class="btn btn-sm btn-outline-success">ä¸‹è½½</a>
            {% if username and (image[2]==request.remote_addr and image[3]==request.cookies.get('device_id')) or is_admin %}
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteImage({{ image[0] }})">åˆ é™¤å›¾ç‰‡</button>
            {% endif %}
        </div>
    </div>
    <div>
        <h4>è¯„è®ºåŒº</h4>
        {% if username %}
        <form method="post" action="{{ url_for('comment', image_id=image[0]) }}" class="mb-2">
            <div class="mb-3 d-flex align-items-center">
                <textarea id="commentInput" name="comment" class="form-control me-2" required placeholder="ç•™ä¸‹ä½ çš„è¯„è®ºï¼Œæ”¯æŒè¡¨æƒ…"></textarea>
                <button type="button" id="emoji-btn" class="btn btn-sm btn-light">ğŸ˜Š</button>
            </div>
            <input type="hidden" name="parent_id" value="">
            <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
        </form>
        {% else %}
        <form method="post" action="/set_username" class="mb-2 d-flex flex-row align-items-center">
            <input type="text" name="username" placeholder="è®¾ç½®æ‚¨çš„ç”¨æˆ·å" class="form-control w-25 me-2" required>
            <button type="submit" class="btn btn-sm btn-primary">ä¿å­˜</button>
        </form>
        {% endif %}
        <ul class="list-group mt-3">
            {% for cmt in comments %}
            {% if not cmt[7] %}
            <li class="list-group-item">
                <strong>{{ cmt[4] or 'åŒ¿å' }}</strong> äº {{ cmt[6] }} è¯„è®ºï¼š<br>
                <span>{{ cmt[5]|safe }}</span>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="showReply({{cmt[0]}})">å›å¤</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="likeComment({{cmt[0]}})">ç‚¹èµ (<span id="comment-like-{{cmt[0]}}">{{cmt[8]}}</span>)</button>
                </div>
                <!-- æ¬¡çº§è¯„è®º -->
                <ul class="list-group mt-2">
                    {% for subcmt in comments if subcmt[7]==cmt[0] %}
                    <li class="list-group-item">
                        <strong>{{ subcmt[4] or 'åŒ¿å' }}</strong> äº {{ subcmt[6] }} å›å¤ï¼š<br>
                        <span>{{ subcmt[5]|safe }}</span>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="likeComment({{subcmt[0]}})">ç‚¹èµ (<span id="comment-like-{{subcmt[0]}}">{{subcmt[8]}}</span>)</button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                <form method="post" action="{{ url_for('comment', image_id=image[0]) }}" id="reply-form-{{cmt[0]}}" style="display:none;" class="mt-2">
                    <div class="mb-2">
                        <textarea name="comment" class="form-control" required placeholder="å›å¤å†…å®¹ï¼Œæ”¯æŒè¡¨æƒ…"></textarea>
                    </div>
                    <input type="hidden" name="parent_id" value="{{cmt[0]}}">
                    <button type="submit" class="btn btn-sm btn-success">å‘è¡¨å›å¤</button>
                </form>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showReply(comment_id) {
    var replyForm = document.getElementById('reply-form-' + comment_id);
    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
}
function likeComment(comment_id) {
    fetch('/comment_like/' + comment_id, {method: "POST"})
    .then(response => response.json())
    .then(data => {
        if(data.success){
            let countElem = document.getElementById('comment-like-' + comment_id);
            countElem.innerText = parseInt(countElem.innerText) + 1;
        }
    });
}
function deleteImage(image_id) {
    if(confirm('ç¡®å®šè¦åˆ é™¤è¯¥å›¾ç‰‡å—ï¼Ÿ')) {
        fetch('/delete/' + image_id, {method: "POST"})
        .then(response => response.json())
        .then(data => {
            if(data.success){
                alert("å›¾ç‰‡å·²åˆ é™¤ï¼Œé¡µé¢å³å°†åˆ·æ–°ï¼");
                setTimeout(() => { location.href = '/'; }, 1500);
            }else{
                alert(data.message || "åˆ é™¤å¤±è´¥");
            }
        });
    }
}
function toggleLikeUsers(image_id) {
    let div = document.getElementById('like-users-' + image_id);
    if(div.classList.contains('show')) {
        div.classList.remove('show');
        div.innerHTML = '';
        return;
    }
    fetch('/like_users/' + image_id)
    .then(response => response.json())
    .then(users => {
        div.innerHTML = '<div class="card card-body">' + (users.length ? users.join('<br>') : 'æš‚æ— ç‚¹èµ') + '</div>';
        div.classList.add('show');
    });
}
// emoji-picker
const button = document.querySelector('#emoji-btn');
const input = document.querySelector('#commentInput');
const picker = new EmojiButton();
button.addEventListener('click', () => {
    picker.togglePicker(button);
});
picker.on('emoji', emoji => {
    input.value += emoji;
});
</script>
</body>
</html>